<html>
<head>
    <meta charset="utf-8">
    <title>Department</title>
<#include "common_css.ftl">
</head>
<body>
<div class="container">
<#include "header.ftl">
    <div >
        <div class="input-group">
            <input id="search_string" type="text" class="form-control" placeholder="Search By Name">
            <span class="input-group-btn">
                <button id="search_button" class="btn btn-default" type="button">Search</button>
                <#if !readonly>
                <button id="create_button" class="btn btn-default" type="button">Create</button>
                </#if>
            </span>
        </div>
    </div>
    <br/>
    <div id="standard_search_results"></div>
</div>

<script id="table-template" type="text/x-handlebars-template">
    <table class="table table-hover">
        <thead>
            <tr>
                <th style="min-width:100px;">漏洞名称</th>
                <th style="min-width:100px;">数量</th>
                <th style="min-width:100px;">漏洞发现方</th>
                <th style="min-width:100px;">录入人</th>
                <th style="min-width:100px;">涉及URL</th>
                <th style="min-width:100px;">系统负责人</th>
                <th style="min-width:100px;">发现时间</th>
                <th style="min-width:100px;">解决时间</th>
                <#if !readonly>
                <th style="width:15%;min-width:160px;"></th>
                </#if>
            </tr>
        </thead>
        <tbody>
            {{#each results}}
            <tr dataId="{{id}}">
                <td>{{name}}</td>
                <td>{{quantity}}</td>
                <td>{{discoverer}}</td>
                <td>{{creater}}</td>
                <td>{{url}}</td>
                <td>{{director}}</td>
                <td>{{discovererTime}}</td>
                <td>{{solvingTime}}</td>
                <#if !readonly>
                    <td style="padding-right:0px;width:200px;">
                        <button class="btn btn-default" evidence="{{this.id}}" action="update">Update</button>
                        <button class="btn btn-default" evidence="{{this.id}}" action="delete">Delete</button>
                    </td>
                </#if>
            </tr>
            {{/each}}
        </tbody>
        <tfoot>
            <tr>
                <td colspan="9">
                    <div style="float:left;" id="pageInfo">{{page-info this}}</div>
                    <div style="float:right;">
                        {{#if hasPrevPage}}<a id="prevPage" href="javascript:void(0)" style="margin-right:20px;">前一页</a>{{/if}}
                        {{#if hasNextPage}}<a id="nextPage" href="javascript:void(0)" style="margin-left:30px;">后一页</a>{{/if}}
                    </div>
                </td>
            </tr>
        </tfoot>
    </table>
</script>
<div style="display:none;overflow-x:hidden;" id="update_dialog">
    <form id="itemForm" class="form-horizontal">
        <input type="hidden" name="id"/>
        <div class="form-group">
            <label for="create-name" class="col-sm-4 control-label">漏洞名称</label>
            <div class="col-sm-7">
                <input class="form-control" id="create-name" name="name" maxlength="64"/>
            </div>
        </div>

        <div class="form-group">
            <label for="create-quantity" class="col-sm-4 control-label">数量</label>
            <div class="col-sm-7">
                <input class="form-control" id="create-quantity" type="number" name="quantity" maxlength="10">
            </div>
        </div>
        <div class="form-group">
            <label for="create-discoverer" class="col-sm-4 control-label">漏洞发现方</label>
            <div class="col-sm-7">
                <input class="form-control" id="create-discoverer" name="discoverer" maxlength="64"/>
            </div>
        </div>
        <div class="form-group">
            <label for="create-creater" class="col-sm-4 control-label">录入人</label>
            <div class="col-sm-7">
                <input class="form-control" id="create-creater" name="creater" maxlength="64"/>
            </div>
        </div>
        <div class="form-group">
            <label for="create-url" class="col-sm-4 control-label">涉及URL</label>
            <div class="col-sm-7">
                <input class="form-control" id="create-url" name="url" maxlength="256"/>
            </div>
        </div>
        <div class="form-group">
            <label for="create-director" class="col-sm-4 control-label">系统负责人</label>
            <div class="col-sm-7">
                <input class="form-control" id="create-director" name="director" maxlength="64"/>
            </div>
        </div>
        <div class="form-group">
            <label for="create-discovererTime" class="col-sm-4 control-label">发现时间</label>
            <div class="col-sm-7">
                <input class="form-control" id="create-discovererTime" name="discovererTime"/>
            </div>
        </div>

        <div class="form-group">
            <label for="create-solvingTime" class="col-sm-4 control-label">解决时间</label>
            <div class="col-sm-7">
                <input class="form-control" id="create-solvingTime" name="solvingTime"/>
            </div>
        </div>
    </form>

    <div align="right">
        <button class="btn btn-primary" id="update-btn">Update</button>
    </div>
</div>
<#include "common_js.ftl">
<script type="text/javascript">
    var search_results_template = Handlebars.compile($("#table-template").html());

    var pageResult = $("#standard_search_results");
    var dialog = $("#update_dialog");
    var id = $("#itemForm input[name='id']");
    var $name = $("#itemForm input[name='name']");
    var quantity = $("#itemForm input[name='quantity']");
    var discoverer = $("#itemForm input[name='discoverer']");
    var creater = $("#itemForm input[name='creater']");
    var url = $("#itemForm input[name='url']");
    var director = $("#itemForm input[name='director']");
    var discovererTime = $("#itemForm input[name='discovererTime']");
    var solvingTime = $("#itemForm input[name='solvingTime']");

    var updateBtn = $("#update-btn");

    discovererTime.datetimepicker({
        format:'yyyy-mm-dd',
        autoclose:true,
        todayBtn:true,
        minView:3,
        initialDate:new Date()
    });
    solvingTime.datetimepicker({
        format:'yyyy-mm-dd',
        autoclose:true,
        todayBtn:true,
        minView:3
    });

    function setupUI(ui, depts) {
        for (var i = 0; i < depts.length; ++i) {
            var item = depts[i];
            var row = ui.find("[dataId='" + item.id + "']");
            var action = row.find("[action]");
            if (action.length) {
                action.unbind();
                action.click(
                        { item: item},
                        function (e) {
                            var action = $(this).attr('action');
                            if(action=='delete'){
                                IsmsRequester.requestJson(
                                    "/api/vulnerability/" + e.data.item.id,
                                    "DELETE",
                                    { },
                                    function (response) {
                                        ui.find("[dataId='" + e.data.item.id + "']").remove();
                                    });
                            }

                            if(action=='update'){
                                clearForm();
                                id.val(e.data.item.id);
                                descripiton.val(e.data.item.descripiton);
                                system.val(e.data.item.system);
                                releaseDate.val(e.data.item.releaseDate);
                                suggestion.val(e.data.item.suggestion);
                                updateBtn.html('Update').unbind();
                                updateBtn.click(e.data,function(){
                                    if(!clearFormErrAndCheck()) return false;

                                    IsmsRequester.requestJson(
                                            "/api/vulnerability/" + e.data.item.id,
                                            "PATCH",
                                            { id:id.val(),name: $name.val(),quantity:quantity.val(),discoverer:discoverer.val(),
                                                creater:creater.val(),url:url.val(),
                                                director:director.val(),discovererTime:discovererTime.val(),solvingTime:solvingTime.val()},
                                            function (response) {
                                                ui.find("[dataId='" + e.data.item.id + "'] td:eq(0)").html(descripiton.val());
                                                ui.find("[dataId='" + e.data.item.id + "'] td:eq(1)").html(system.val());
                                                ui.find("[dataId='" + e.data.item.id + "'] td:eq(2)").html(releaseDate.val());
                                                ui.find("[dataId='" + e.data.item.id + "'] td:eq(3)").html(suggestion.val());
                                                dialog.dialog('close');
                                            });
                                });
                                dialog.dialog({modal: true,title:'修改漏洞模块数据'});
                            }

                        });
            }
        }
    }

    function updateSearchResults(namePattern, pageNumber) {
        IsmsRequester.requestJson(
                "/api/vulnerabilities",
                "POST",
                {
                    name: namePattern,
                    itemPerPage: 10,
                    pageNumber: pageNumber
                },
                function (response) {
                    if (response.pageNumber > 0) {
                        response.hasPrevPage = true;
                    }
                    pageResult.html(search_results_template(response));
                    setupUI(pageResult, response.results);
                    var prevPage = $("#prevPage");
                    if (prevPage.length && response.pageNumber > 0) {
                        prevPage.click(function () {
                            updateSearchResults(namePattern, pageNumber - 1);
                        });
                    }
                    var nextPage = $("#nextPage");
                    if (nextPage.length && response.hasNextPage) {
                        nextPage.click(function () {
                            updateSearchResults(namePattern, pageNumber + 1);
                        });
                    }
                }
        );
    }

    $("#search_button").click(function () {
        var namePattern = $("#search_string").prop("value");
        updateSearchResults(namePattern, 0);
    });

    function clearForm() {
        $("#itemForm input").val('');
        $("#itemForm textarea").val('');
    }

    function clearFormErrAndCheck() {
        $("#itemForm input+span").remove();
        $("#itemForm textarea+span").remove();

        if($name.val()==''){
            $name.after('<span class="help-block">漏洞名称不能为空.</span>');
            return false;
        }
        if(quantity.val()==''){
            quantity.after('<span class="help-block">数量不能为空.</span>');
            return false;
        }
        if(creater.val()==''){
            creater.after('<span class="help-block">录入人不能为空.</span>');
            return false;
        }
        if(url.val()==''){
            url.after('<span class="help-block">涉及URL不能为空.</span>');
            return false;
        }
        if(discovererTime.val()==''){
            discovererTime.after('<span class="help-block">发现时间不能为空.</span>');
            return false;
        }
        return true;
    }

    $("#create_button").click(function () {
        clearForm();
        updateBtn.html('Create').unbind();
        updateBtn.click(function(){
            if(!clearFormErrAndCheck()) return false;

            IsmsRequester.requestJson(
                    "/api/vulnerability",
                    "POST",
                    { name: $name.val(),quantity:quantity.val(),discoverer:discoverer.val(),creater:creater.val(),url:url.val(),
                        director:director.val(),discovererTime:discovererTime.val(),solvingTime:solvingTime.val()},
                    function (response) {

                        var datas = [{id:response.id,name: $name.val(),quantity:quantity.val(),discoverer:discoverer.val(),creater:creater.val(),url:url.val(),
                                director:director.val(),discovererTime:discovererTime.val(),solvingTime:solvingTime.val()}];
                        $("#standard_search_results tbody").prepend($(search_results_template({results:datas})).find("tbody tr:first"));
                        setupUI(pageResult, datas);
                        dialog.dialog('close');
                    });
        });
        dialog.dialog({modal: true,title:'创建漏洞模块数据',width:400});
    });

    updateSearchResults('',0);
</script>
</body>
</html>